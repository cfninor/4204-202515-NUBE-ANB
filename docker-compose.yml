services:
  postgres:
    image: postgres:16-alpine
    container_name: pg-anb
    environment:
      POSTGRES_DB: anbdb
      POSTGRES_USER: anbuser
      POSTGRES_PASSWORD: anbpass
    volumes: [ ".pgdata:/var/lib/postgresql/data" ]
    ports: [ "5434:5432" ]

  pgbouncer:
    image: edoburu/pgbouncer:latest
    container_name: pgbouncer-anb
    environment:
      DB_USER: anbuser
      DB_PASSWORD: anbpass
      DB_HOST: postgres
      DB_NAME: anbdb
      POOL_MODE: transaction
      MAX_CLIENT_CONN: 2000
      DEFAULT_POOL_SIZE: 50
      AUTH_TYPE: scram-sha-256
    depends_on: [ postgres ]
    ports: [ "6432:5432" ] 

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: rabbitmq-anb
    ports: [ "5672:5672", "15672:15672" ]

  redis:
    image: redis:7-alpine
    container_name: redis-anb
    ports: [ "6379:6379" ]

  api:
    build: 
      context: .
      dockerfile: anbapi/Dockerfile
    env_file: .env
    depends_on: [ pgbouncer, rabbitmq, redis ]
    working_dir: /app/app
    volumes:
      - ./anbapi/app/storage:/app/app/storage
    ports: [ "8000:8000" ]
    command: >
      sh -lc "python prestart.py && exec gunicorn main:app --bind 0.0.0.0:8000 --worker-class uvicorn.workers.UvicornWorker --workers 3 --keep-alive 5 --max-requests 2000 --max-requests-jitter 200"
